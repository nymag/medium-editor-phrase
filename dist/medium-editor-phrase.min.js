!function(e,t){"object"==typeof module?module.exports=t:"function"==typeof define&&define.amd?define(t):e.MediumEditorPhrase=t}(this,function(e){const t="safariNeedsTextNode!@#$%^()*~",n='<div data-phrase-placeholder="true"></div>';return e.extensions.button.extend({phraseTagName:"span",phraseClassList:[],name:"phrase",contentDefault:"S",aria:"Span Button",classList:[],init:function(){e.Extension.prototype.init.apply(this,arguments),this.useQueryState=!1,this.phraseHasNoClass=0===this.phraseClassList.length,this.phraseSelector=this.phraseTagName+this.phraseClassList.reduce(((e,t)=>e+"."+t),""),this.openingTag=`<${this.phraseTagName}${this.phraseHasNoClass?"":' class="'+this.phraseClassList.join(" ").trim()+'"'}>`,this.closingTag=`</${this.phraseTagName}>`,this.button=this.createButton(),this.on(this.button,"click",this.handleClick.bind(this))},cloneSelection:function(){var t=e.selection.getSelectionRange(this.document),n=document.createElement("div");return n.appendChild(t.cloneContents()),n},isPhraseNode:function(e){return!(!e||e.tagName.toLowerCase()!==this.phraseTagName||(this.phraseHasNoClass?e.className:!this.phraseClassList.reduce(((t,n)=>t&&e.classList.contains(n)),!0)))},removePhraseTags:function(e){e.outerHTML=e.innerHTML},addPhraseTags:function(e){var t="",n="";return(e=e.replace(/^(<\/[^>]+>)*/,(function(e){return t=e,""})).replace(/(<[^\/>]+>)*$/,(function(e){return n=e,""})))&&(e=this.openingTag+e+this.closingTag),t+e+n},getSelectionPhrases:function(e){var t=Array.prototype.slice.call(e.querySelectorAll(this.phraseSelector));return this.phraseHasNoClass&&(t=t.filter((e=>!e.className))),t},replaceSelectionHtml:function(t,n){var s,i=e.selection.getSelectionRange(this.document),r=this.document.getSelection();i.deleteContents(),s=i.createContextualFragment(t),i.insertNode(s),r.removeAllRanges(),!1!==n&&(s.firstChild&&(i.setStartBefore(s.firstChild),i.setEndAfter(s.lastChild)),r.addRange(i))},getNodeHtml:function(e){switch(e.nodeType){case Node.ELEMENT_NODE:return e.innerHTML;case Node.TEXT_NODE:return e.textContent;default:return e.innerHTML||e.textContent||""}},isAlreadyApplied:function(){return this.hasSelectionPhrase()||!!this.getAncestorPhrase()},insertTextNodePlaceholder:function(e,n){return e.parentNode.insertBefore(this.document.createTextNode(t),n?e.nextSibling:e)},insertTextNodePlaceholderBefore:function(e){return this.insertTextNodePlaceholder(e)},insertTextNodePlaceholderAfter:function(e){return this.insertTextNodePlaceholder(e,!0)},removeAncestorPhrase:function(e){var t,s,i=e.parentNode,r=this.getNodeHtml(this.cloneSelection()),a=this.document.getSelection(),o=this.document.createRange();return this.replaceSelectionHtml(n,!1),e.outerHTML=e.cloneNode(!0).innerHTML.split(n).map((e=>e&&this.addPhraseTags(e))).join(n),a.removeAllRanges(),t=i.querySelector('div[data-phrase-placeholder="true"]'),s=this.insertTextNodePlaceholderAfter(t),t.parentNode.removeChild(t),o.selectNode(s),a.addRange(o),r},isLastDescendantTextNode:function(e,t){for(var n,s,i=!0,r=this.document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);n=r.nextNode()&&i;)s&&(i=!1),n===e&&(s=!0);return i},isFirstDescendantTextNode:function(e,t){return e===this.document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1).firstChild()},ensurePhraseSelected:function(){var t,n,s=this.window.getSelection(),i=e.selection.getSelectionRange(this.document),r=i.startContainer,a=i.startOffset,o=i.endContainer,h=i.endOffset,l=o!==r,c=o.nodeType===Node.TEXT_NODE&&h===o.textContent.length,d=r.nodeType===Node.TEXT_NODE&&0===a,u=this.document.createRange();l&&(c&&(t=e.util.traverseUp(o,this.isPhraseNode.bind(this)))&&this.isLastDescendantTextNode(o,t)&&(n=this.insertTextNodePlaceholderAfter(t),u.setStart(r,a),u.setEnd(n.parentNode,function(e){for(var t=1,n=e.parentNode.firstChild;n!==e;)t+=1,n=n.nextSibling;return t}(n))),d&&(t=e.util.traverseUp(r,this.isPhraseNode.bind(this)))&&this.isFirstDescendantTextNode(r,t)&&(u.setStart(this.insertTextNodePlaceholderBefore(t),0),n||u.setEnd(o,h)),u.collapsed||(s.removeAllRanges(),s.addRange(u)))},togglePhraseTags:function(){var e,n,s;return this.ensurePhraseSelected(),e=this.cloneSelection(),n=this.getSelectionPhrases(e),s=e.innerHTML,n.length?(n.forEach(this.removePhraseTags),s=e.innerHTML):e.textContent&&(s=this.addPhraseTags(s)),function(e){return e.split(t).join("")}(s)},hasSelectionPhrase:function(){return this.getSelectionPhrases(this.cloneSelection()).length>0},getAncestorPhrase:function(){return e.util.traverseUp(e.selection.getSelectionRange(this.document).startContainer,this.isPhraseNode.bind(this))},handleClick:function(e){var t=this.getAncestorPhrase();e.preventDefault(),e.stopPropagation(),this.replaceSelectionHtml(!t||this.hasSelectionPhrase()?this.togglePhraseTags():this.removeAncestorPhrase(t)),this.isAlreadyApplied()?this.setActive():this.setInactive(),this.base.checkContentChanged()}})}("function"==typeof require?require("medium-editor"):MediumEditor));
